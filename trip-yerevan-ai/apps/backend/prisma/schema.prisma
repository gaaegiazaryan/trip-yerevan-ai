// ============================================================================
// Trip Yerevan AI â€” Prisma Schema
// Based on: docs/domain-model.md
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Language {
  RU
  AM
  EN
}

enum UserRole {
  TRAVELER
  MANAGER
  ADMIN
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum AgencyStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
  BLOCKED
}

enum AgencyRole {
  OWNER
  AGENT
  VIEWER
}

enum AgencyMembershipStatus {
  INVITED
  ACTIVE
  DISABLED
}

enum TravelRequestStatus {
  DRAFT
  COLLECTING_INFO
  READY
  DISTRIBUTED
  OFFERS_RECEIVED
  IN_NEGOTIATION
  BOOKED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum TripType {
  PACKAGE
  FLIGHT_ONLY
  HOTEL_ONLY
  EXCURSION
  CUSTOM
}

enum Currency {
  AMD
  USD
  EUR
  RUB
}

enum OfferStatus {
  DRAFT
  SUBMITTED
  VIEWED
  ACCEPTED
  REJECTED
  BOOKED
  WITHDRAWN
  EXPIRED
}

enum OfferItemType {
  FLIGHT
  HOTEL
  TRANSFER
  INSURANCE
  EXCURSION
  OTHER
}

enum ProxyChatStatus {
  OPEN
  BOOKED
  MANAGER_ASSIGNED
  COMPLETED
  CLOSED
  ARCHIVED
}

enum MessageSenderType {
  USER
  AGENCY
  SYSTEM
}

enum MessageContentType {
  TEXT
  PHOTO
  DOCUMENT
}

enum BookingStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  PAID
  COMPLETED
  CANCELLED
  REJECTED
}

enum AIConversationStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  FAILED
}

enum AIMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum AIModel {
  CLAUDE
  OPENAI
}

enum RfqDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  VIEWED
  RESPONDED
}

enum HotelStars {
  ONE
  TWO
  THREE
  FOUR
  FIVE
}

enum MealPlan {
  RO
  BB
  HB
  FB
  AI
  UAI
}

enum FlightClass {
  ECONOMY
  BUSINESS
}

enum TransferType {
  GROUP
  PRIVATE
  VIP
}

enum AttachmentType {
  HOTEL_IMAGE
  ITINERARY_PDF
  VOUCHER
  OTHER
}

// ============================================================================
// USERS
// ============================================================================

model User {
  id                String   @id @default(uuid()) @db.Uuid
  telegramId        BigInt   @unique
  firstName         String
  lastName          String?
  phone             String?
  preferredLanguage Language  @default(RU)
  role              UserRole @default(TRAVELER)
  status            UserStatus @default(ACTIVE)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  memberships          AgencyMembership[]
  invitedMemberships   AgencyMembership[] @relation("MembershipInviter")
  travelRequests       TravelRequest[]
  bookings             Booking[]
  proxyChats           ProxyChat[]
  aiConversations      AIConversation[]
  bookingHistory       BookingStatusHistory[]
  applications         AgencyApplication[] @relation("ApplicationApplicant")
  reviewedApplications AgencyApplication[] @relation("ApplicationReviewer")
  verifiedAgencies     Agency[]            @relation("AgencyVerifier")
  managedProxyChats    ProxyChat[]         @relation("ProxyChatManager")

  @@map("users")
}

// ============================================================================
// AGENCIES
// ============================================================================

model Agency {
  id              String       @id @default(uuid()) @db.Uuid
  name            String       @unique
  description     String?
  contactEmail     String?
  contactPhone     String
  telegramChatId       BigInt?
  agencyTelegramChatId BigInt?
  status               AgencyStatus @default(PENDING)
  specializations  String[]     @default([])
  regions          String[]     @default([])
  rating           Decimal      @default(0) @db.Decimal(3, 2)
  verifiedAt       DateTime?
  verifiedByUserId String?      @db.Uuid
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  verifiedBy       User?        @relation("AgencyVerifier", fields: [verifiedByUserId], references: [id])
  memberships      AgencyMembership[]
  offers           Offer[]
  proxyChats       ProxyChat[]
  bookings         Booking[]
  rfqDistributions RfqDistribution[]

  @@map("agencies")
}

model AgencyMembership {
  id              String                  @id @default(uuid()) @db.Uuid
  agencyId        String                  @db.Uuid
  userId          String                  @db.Uuid
  role            AgencyRole
  status          AgencyMembershipStatus  @default(ACTIVE)
  invitedByUserId String?                 @db.Uuid
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  // Relations
  agency    Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitedBy User?  @relation("MembershipInviter", fields: [invitedByUserId], references: [id])
  offers    Offer[]

  @@unique([agencyId, userId])
  @@index([userId])
  @@map("agency_memberships")
}

// ============================================================================
// TRAVEL REQUESTS
// ============================================================================

model TravelRequest {
  id        String              @id @default(uuid()) @db.Uuid
  userId    String              @db.Uuid
  status    TravelRequestStatus @default(DRAFT)
  rawText   String
  language  Language

  // ParsedTravelData (embedded value object)
  destination   String?
  departureCity String   @default("Yerevan")
  departureDate DateTime? @db.Date
  returnDate    DateTime? @db.Date
  tripType      TripType?

  // TravelerGroup (embedded value object)
  adults       Int   @default(1)
  children     Int   @default(0)
  childrenAges Int[] @default([])
  infants      Int   @default(0)

  // Budget
  budgetMin   Decimal?  @db.Decimal(12, 2)
  budgetMax   Decimal?  @db.Decimal(12, 2)
  currency    Currency  @default(USD)
  preferences String[]  @default([])
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime

  // Relations
  user              User              @relation(fields: [userId], references: [id])
  offers            Offer[]
  proxyChats        ProxyChat[]
  booking           Booking?
  aiConversation    AIConversation?
  rfqDistributions  RfqDistribution[]

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("travel_requests")
}

// ============================================================================
// OFFERS
// ============================================================================

model Offer {
  id              String      @id @default(uuid()) @db.Uuid
  travelRequestId String      @db.Uuid
  agencyId        String      @db.Uuid
  membershipId    String      @db.Uuid
  status          OfferStatus @default(DRAFT)
  totalPrice      Decimal     @db.Decimal(12, 2)
  currency        Currency
  description     String
  validUntil      DateTime
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Price details
  priceIncludes   String[]    @default([])
  priceExcludes   String[]    @default([])

  // Hotel
  hotelName        String?
  hotelStars       HotelStars?
  roomType         String?
  mealPlan         MealPlan?
  hotelLocation    String?
  hotelDescription String?

  // Flight
  airline               String?
  departureFlightNumber String?
  returnFlightNumber    String?
  baggageIncluded       Boolean?
  flightClass           FlightClass?

  // Transfer
  transferIncluded Boolean?
  transferType     TransferType?

  // Travel details
  departureDate     DateTime? @db.Date
  returnDate        DateTime? @db.Date
  nightsCount       Int?
  adults            Int?
  children          Int?
  insuranceIncluded Boolean?

  // Relations
  travelRequest TravelRequest    @relation(fields: [travelRequestId], references: [id])
  agency        Agency           @relation(fields: [agencyId], references: [id])
  membership    AgencyMembership @relation(fields: [membershipId], references: [id])
  items         OfferItem[]
  attachments   OfferAttachment[]
  booking       Booking?
  proxyChats    ProxyChat[]

  @@unique([travelRequestId, agencyId])
  @@index([travelRequestId])
  @@index([agencyId])
  @@index([status])
  @@map("offers")
}

model OfferItem {
  id          String        @id @default(uuid()) @db.Uuid
  offerId     String        @db.Uuid
  type        OfferItemType
  title       String
  description String?
  price       Decimal       @db.Decimal(12, 2)
  currency    Currency
  createdAt   DateTime      @default(now())

  // Relations
  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@map("offer_items")
}

model OfferAttachment {
  id             String         @id @default(uuid()) @db.Uuid
  offerId        String?        @db.Uuid
  draftChatId    BigInt?
  type           AttachmentType
  telegramFileId String
  fileName       String?
  mimeType       String?
  createdAt      DateTime       @default(now())

  // Relations
  offer Offer? @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@index([draftChatId])
  @@map("offer_attachments")
}

// ============================================================================
// PROXY CHAT
// ============================================================================

model ProxyChat {
  id              String          @id @default(uuid()) @db.Uuid
  travelRequestId String          @db.Uuid
  userId          String          @db.Uuid
  agencyId        String          @db.Uuid
  offerId         String?         @db.Uuid
  status          ProxyChatStatus @default(OPEN)
  closedReason    String?
  managerId       String?         @db.Uuid
  createdAt       DateTime        @default(now())
  closedAt        DateTime?

  // Relations
  travelRequest TravelRequest    @relation(fields: [travelRequestId], references: [id])
  user          User             @relation(fields: [userId], references: [id])
  agency        Agency           @relation(fields: [agencyId], references: [id])
  offer         Offer?           @relation(fields: [offerId], references: [id])
  manager       User?            @relation("ProxyChatManager", fields: [managerId], references: [id], onDelete: SetNull)
  messages      ProxyChatMessage[]
  auditLogs     ChatAuditLog[]

  @@unique([travelRequestId, userId, agencyId])
  @@index([userId])
  @@index([agencyId])
  @@index([status])
  @@index([managerId])
  @@map("proxy_chats")
}

model ProxyChatMessage {
  id             String             @id @default(uuid()) @db.Uuid
  proxyChatId    String             @db.Uuid
  senderType     MessageSenderType
  senderId       String             @db.Uuid
  content        String             @db.VarChar(4000)
  contentType    MessageContentType @default(TEXT)
  telegramFileId String?
  createdAt      DateTime           @default(now())
  readAt         DateTime?

  // Relations
  proxyChat ProxyChat @relation(fields: [proxyChatId], references: [id], onDelete: Cascade)

  @@index([proxyChatId, createdAt])
  @@map("proxy_chat_messages")
}

model ChatAuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  proxyChatId String   @db.Uuid
  eventType   String
  actorId     String?  @db.Uuid
  details     Json?
  createdAt   DateTime @default(now())

  // Relations
  proxyChat ProxyChat @relation(fields: [proxyChatId], references: [id], onDelete: Cascade)

  @@index([proxyChatId, createdAt])
  @@index([eventType])
  @@map("chat_audit_logs")
}

// ============================================================================
// BOOKINGS
// ============================================================================

model Booking {
  id              String        @id @default(uuid()) @db.Uuid
  travelRequestId String        @unique @db.Uuid
  offerId         String        @unique @db.Uuid
  userId          String        @db.Uuid
  agencyId        String        @db.Uuid
  status          BookingStatus @default(PENDING_CONFIRMATION)
  totalPrice      Decimal       @db.Decimal(12, 2)
  currency        Currency
  confirmedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  travelRequest TravelRequest          @relation(fields: [travelRequestId], references: [id])
  offer         Offer                  @relation(fields: [offerId], references: [id])
  user          User                   @relation(fields: [userId], references: [id])
  agency        Agency                 @relation(fields: [agencyId], references: [id])
  statusHistory BookingStatusHistory[]

  @@index([userId])
  @@index([agencyId])
  @@index([status])
  @@map("bookings")
}

model BookingStatusHistory {
  id         String        @id @default(uuid()) @db.Uuid
  bookingId  String        @db.Uuid
  fromStatus BookingStatus
  toStatus   BookingStatus
  changedBy  String        @db.Uuid
  reason     String?
  createdAt  DateTime      @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [changedBy], references: [id])

  @@index([bookingId, createdAt])
  @@map("booking_status_history")
}

// ============================================================================
// AI CONVERSATIONS
// ============================================================================

model AIConversation {
  id              String               @id @default(uuid()) @db.Uuid
  userId          String               @db.Uuid
  travelRequestId String?              @unique @db.Uuid
  status          AIConversationStatus @default(ACTIVE)
  model           AIModel
  tokensUsed      Int                  @default(0)
  createdAt       DateTime             @default(now())
  completedAt     DateTime?

  // AI Engine state
  conversationState String?
  draftData         Json?
  draftSnapshots    Json?
  detectedLanguage  String?

  // Relations
  user            User              @relation(fields: [userId], references: [id])
  travelRequest   TravelRequest?    @relation(fields: [travelRequestId], references: [id])
  messages        AIMessage[]
  feedbackSignals AIFeedbackSignal[]

  @@index([userId, status])
  @@map("ai_conversations")
}

model AIMessage {
  id             String        @id @default(uuid()) @db.Uuid
  conversationId String        @db.Uuid
  role           AIMessageRole
  content        String
  tokens         Int?
  createdAt      DateTime      @default(now())

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

model AIFeedbackSignal {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @db.Uuid
  type           String
  fieldName      String?
  originalValue  Json?
  correctedValue Json?
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([type])
  @@map("ai_feedback_signals")
}

// ============================================================================
// RFQ DISTRIBUTION
// ============================================================================

model RfqDistribution {
  id               String            @id @default(uuid()) @db.Uuid
  travelRequestId  String            @db.Uuid
  agencyId         String            @db.Uuid
  deliveryStatus   RfqDeliveryStatus @default(PENDING)
  failureReason    String?
  notificationPayload Json?
  distributedAt    DateTime          @default(now())
  deliveredAt      DateTime?
  viewedAt         DateTime?
  respondedAt      DateTime?

  // Relations
  travelRequest TravelRequest @relation(fields: [travelRequestId], references: [id], onDelete: Cascade)
  agency        Agency        @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([travelRequestId, agencyId])
  @@index([travelRequestId])
  @@index([agencyId])
  @@index([deliveryStatus])
  @@map("rfq_distributions")
}

// ============================================================================
// AGENCY APPLICATIONS
// ============================================================================

enum AgencyApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

model AgencyApplication {
  id              String                  @id @default(uuid()) @db.Uuid
  applicantUserId String                  @db.Uuid
  draftData       Json
  status          AgencyApplicationStatus @default(SUBMITTED)
  reviewerUserId  String?                 @db.Uuid
  decisionReason  String?
  createdAt       DateTime                @default(now())
  decidedAt       DateTime?

  // Relations
  applicant User  @relation("ApplicationApplicant", fields: [applicantUserId], references: [id])
  reviewer  User? @relation("ApplicationReviewer", fields: [reviewerUserId], references: [id])

  @@index([applicantUserId])
  @@index([status])
  @@map("agency_applications")
}
