// ============================================================================
// Trip Yerevan AI â€” Prisma Schema
// Based on: docs/domain-model.md
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Language {
  RU
  AM
  EN
}

enum UserRole {
  TRAVELER
  ADMIN
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum AgencyStatus {
  PENDING
  VERIFIED
  SUSPENDED
  BLOCKED
}

enum AgentRole {
  OWNER
  MANAGER
  AGENT
}

enum AgentStatus {
  ACTIVE
  INACTIVE
}

enum TravelRequestStatus {
  DRAFT
  COLLECTING_INFO
  READY
  DISTRIBUTED
  OFFERS_RECEIVED
  IN_NEGOTIATION
  BOOKED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum TripType {
  PACKAGE
  FLIGHT_ONLY
  HOTEL_ONLY
  EXCURSION
  CUSTOM
}

enum Currency {
  AMD
  USD
  EUR
  RUB
}

enum OfferStatus {
  DRAFT
  SUBMITTED
  VIEWED
  ACCEPTED
  REJECTED
  BOOKED
  WITHDRAWN
  EXPIRED
}

enum OfferItemType {
  FLIGHT
  HOTEL
  TRANSFER
  INSURANCE
  EXCURSION
  OTHER
}

enum ProxyChatStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

enum MessageSenderType {
  USER
  AGENCY
  SYSTEM
}

enum BookingStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  PAID
  COMPLETED
  CANCELLED
  REJECTED
}

enum AIConversationStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  FAILED
}

enum AIMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum AIModel {
  CLAUDE
  OPENAI
}

// ============================================================================
// USERS
// ============================================================================

model User {
  id                String   @id @default(uuid()) @db.Uuid
  telegramId        BigInt   @unique
  firstName         String
  lastName          String?
  phone             String?
  preferredLanguage Language  @default(RU)
  role              UserRole @default(TRAVELER)
  status            UserStatus @default(ACTIVE)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  agencyAgent      AgencyAgent?
  travelRequests   TravelRequest[]
  bookings         Booking[]
  proxyChats       ProxyChat[]
  aiConversations  AIConversation[]
  bookingHistory   BookingStatusHistory[]

  @@map("users")
}

// ============================================================================
// AGENCIES
// ============================================================================

model Agency {
  id              String       @id @default(uuid()) @db.Uuid
  name            String       @unique
  description     String?
  contactEmail    String
  contactPhone    String
  telegramChatId  BigInt?
  status          AgencyStatus @default(PENDING)
  specializations String[]     @default([])
  regions         String[]     @default([])
  rating          Decimal      @default(0) @db.Decimal(3, 2)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  agents     AgencyAgent[]
  offers     Offer[]
  proxyChats ProxyChat[]
  bookings   Booking[]

  @@map("agencies")
}

model AgencyAgent {
  id        String      @id @default(uuid()) @db.Uuid
  agencyId  String      @db.Uuid
  userId    String      @unique @db.Uuid
  role      AgentRole
  status    AgentStatus @default(ACTIVE)
  createdAt DateTime    @default(now())

  // Relations
  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  offers Offer[]

  @@unique([agencyId, userId])
  @@map("agency_agents")
}

// ============================================================================
// TRAVEL REQUESTS
// ============================================================================

model TravelRequest {
  id        String              @id @default(uuid()) @db.Uuid
  userId    String              @db.Uuid
  status    TravelRequestStatus @default(DRAFT)
  rawText   String
  language  Language

  // ParsedTravelData (embedded value object)
  destination   String?
  departureCity String   @default("Yerevan")
  departureDate DateTime? @db.Date
  returnDate    DateTime? @db.Date
  tripType      TripType?

  // TravelerGroup (embedded value object)
  adults       Int   @default(1)
  children     Int   @default(0)
  childrenAges Int[] @default([])
  infants      Int   @default(0)

  // Budget
  budgetMin   Decimal?  @db.Decimal(12, 2)
  budgetMax   Decimal?  @db.Decimal(12, 2)
  currency    Currency  @default(USD)
  preferences String[]  @default([])
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime

  // Relations
  user            User             @relation(fields: [userId], references: [id])
  offers          Offer[]
  proxyChats      ProxyChat[]
  booking         Booking?
  aiConversation  AIConversation?

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("travel_requests")
}

// ============================================================================
// OFFERS
// ============================================================================

model Offer {
  id              String      @id @default(uuid()) @db.Uuid
  travelRequestId String      @db.Uuid
  agencyId        String      @db.Uuid
  agentId         String      @db.Uuid
  status          OfferStatus @default(DRAFT)
  totalPrice      Decimal     @db.Decimal(12, 2)
  currency        Currency
  description     String
  validUntil      DateTime
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  travelRequest TravelRequest @relation(fields: [travelRequestId], references: [id])
  agency        Agency        @relation(fields: [agencyId], references: [id])
  agent         AgencyAgent   @relation(fields: [agentId], references: [id])
  items         OfferItem[]
  booking       Booking?

  @@unique([travelRequestId, agencyId])
  @@index([travelRequestId])
  @@index([agencyId])
  @@index([status])
  @@map("offers")
}

model OfferItem {
  id          String        @id @default(uuid()) @db.Uuid
  offerId     String        @db.Uuid
  type        OfferItemType
  title       String
  description String?
  price       Decimal       @db.Decimal(12, 2)
  currency    Currency
  createdAt   DateTime      @default(now())

  // Relations
  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@map("offer_items")
}

// ============================================================================
// PROXY CHAT
// ============================================================================

model ProxyChat {
  id              String          @id @default(uuid()) @db.Uuid
  travelRequestId String          @db.Uuid
  userId          String          @db.Uuid
  agencyId        String          @db.Uuid
  status          ProxyChatStatus @default(ACTIVE)
  createdAt       DateTime        @default(now())
  closedAt        DateTime?

  // Relations
  travelRequest TravelRequest    @relation(fields: [travelRequestId], references: [id])
  user          User             @relation(fields: [userId], references: [id])
  agency        Agency           @relation(fields: [agencyId], references: [id])
  messages      ProxyChatMessage[]

  @@unique([travelRequestId, userId, agencyId])
  @@index([userId])
  @@index([agencyId])
  @@map("proxy_chats")
}

model ProxyChatMessage {
  id          String            @id @default(uuid()) @db.Uuid
  proxyChatId String            @db.Uuid
  senderType  MessageSenderType
  senderId    String            @db.Uuid
  content     String            @db.VarChar(4000)
  createdAt   DateTime          @default(now())
  readAt      DateTime?

  // Relations
  proxyChat ProxyChat @relation(fields: [proxyChatId], references: [id], onDelete: Cascade)

  @@index([proxyChatId, createdAt])
  @@map("proxy_chat_messages")
}

// ============================================================================
// BOOKINGS
// ============================================================================

model Booking {
  id              String        @id @default(uuid()) @db.Uuid
  travelRequestId String        @unique @db.Uuid
  offerId         String        @unique @db.Uuid
  userId          String        @db.Uuid
  agencyId        String        @db.Uuid
  status          BookingStatus @default(PENDING_CONFIRMATION)
  totalPrice      Decimal       @db.Decimal(12, 2)
  currency        Currency
  confirmedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  travelRequest TravelRequest          @relation(fields: [travelRequestId], references: [id])
  offer         Offer                  @relation(fields: [offerId], references: [id])
  user          User                   @relation(fields: [userId], references: [id])
  agency        Agency                 @relation(fields: [agencyId], references: [id])
  statusHistory BookingStatusHistory[]

  @@index([userId])
  @@index([agencyId])
  @@index([status])
  @@map("bookings")
}

model BookingStatusHistory {
  id         String        @id @default(uuid()) @db.Uuid
  bookingId  String        @db.Uuid
  fromStatus BookingStatus
  toStatus   BookingStatus
  changedBy  String        @db.Uuid
  reason     String?
  createdAt  DateTime      @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [changedBy], references: [id])

  @@index([bookingId, createdAt])
  @@map("booking_status_history")
}

// ============================================================================
// AI CONVERSATIONS
// ============================================================================

model AIConversation {
  id              String               @id @default(uuid()) @db.Uuid
  userId          String               @db.Uuid
  travelRequestId String?              @unique @db.Uuid
  status          AIConversationStatus @default(ACTIVE)
  model           AIModel
  tokensUsed      Int                  @default(0)
  createdAt       DateTime             @default(now())
  completedAt     DateTime?

  // AI Engine state
  conversationState String?
  draftData         Json?
  draftSnapshots    Json?
  detectedLanguage  String?

  // Relations
  user            User              @relation(fields: [userId], references: [id])
  travelRequest   TravelRequest?    @relation(fields: [travelRequestId], references: [id])
  messages        AIMessage[]
  feedbackSignals AIFeedbackSignal[]

  @@index([userId, status])
  @@map("ai_conversations")
}

model AIMessage {
  id             String        @id @default(uuid()) @db.Uuid
  conversationId String        @db.Uuid
  role           AIMessageRole
  content        String
  tokens         Int?
  createdAt      DateTime      @default(now())

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

model AIFeedbackSignal {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @db.Uuid
  type           String
  fieldName      String?
  originalValue  Json?
  correctedValue Json?
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([type])
  @@map("ai_feedback_signals")
}
